{% extends "layout.html" %}

{% block head %}
    <style>
        .tombstone-design input {
            margin:0;
            padding:0;
            appearance: none;
        }

        .tombstone-design label img {
            cursor: pointer;
            filter: brightness(1.0);
        }

        .tombstone-design input:checked + label img,
        .tombstone-design label img:hover {
            filter: brightness(1.5);
        }

        h3 {
            padding-bottom: 0;
            margin-bottom: 0.2em;
        }

        .popup {
            z-index: 100;
            background-color: rgba(0, 0, 0, 0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            position: fixed;
            height: 100vh;
            width: 100vw;
        }

        .gamepad {
            user-select: none;
            position: fixed;
            right: 12px;
            bottom: 12px;
            display: grid;
            gap: 1px;
            grid-template-columns: repeat(3, 1fr);
        }

        .gamepad img {
            user-select: none;
            width: 64px;
            height: 64px;
            cursor: pointer;
        }

        .gamepad img:hover {
            filter: brightness(1.5);
        }

        .gamepad img:active {
            transform: translateY(2px);
        }

        .hidden {
            display: none !important;
        }
    </style>
{% endblock %}

{% block body %}
    <!-- Add tombstone modal -->
    <div class="popup hidden" id="tombstone-creation">
        <div class="card">
            <form id="tombstone-form">
                {{ form.hidden_tag() }}
                <h1>New Tombstone</h1>
                <div class="tombstone-design">
                    <h3>Tombstone Design</h3>
                    {% for subfield in form.tombstone %}
                        {{ subfield }}
                        <label for="{{ subfield.id }}">
                            <img width="48" height="48" src="{{ subfield.label.text }}" alt="{{ subfield.label.text|replace('../static/assets/tombstones/', '')|replace('.png', '') }}"></label>
                    {% endfor %}
                </div>
            
                <label class="block" for="{{ form.title.id }}">Title</label>
                {{ form.title }}
                {% if form.title.errors %}
                    <ul class="errors">
                    {% for error in form.title.errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                    </ul>
                {% endif %}
            
                <label class="block" for="{{ form.content.id }}">Content</label>
                {{ form.content(style="resize: none;", class="border p-2 w-full mb-2") }}
            
                <div>
                    {% for subfield in form.emotion %}
                        {{ subfield }} {{ subfield.label }}
                    {% endfor %}
                </div>
            
                <div>
                    <h3>Visibility</h3>
                    {% for subfield in form.space %}
                        {{ subfield }} {{ subfield.label }}
                    {% endfor %}
                </div>
                <br>
                <div>
                    <button type="button" onclick="hideTombstoneCreator()">Cancel</button>
                    <button type="submit">Submit</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Tombstone content modal to be populated by current tombstone data -->
    <div class="popup hidden" id="tombstone-content">
        <div class="card" onclick="hideTombstone()">
            <h2 id="tombstone-text"></h2>
            <h2 id="tombstone-likes"></h2>
        </div>
    </div>

    <!-- Virtual gamepad controls -->
    <div class="gamepad">
        <div class="control"></div>
        <div class="control">
            <img draggable="false" class="virtual-control" id="ArrowUp" src="../static/assets/controls/up.png" alt="up">
        </div>
        <div class="control"></div>
        <div class="control">
            <img draggable="false" class="virtual-control" id="ArrowLeft" src="../static/assets/controls/left.png" alt="left">
        </div>
        <div class="control">
            <img draggable="false" class="virtual-control" id="space" src="../static/assets/controls/select.png" alt="select">
        </div>
        <div class="control">
            <img draggable="false" class="virtual-control" id="ArrowRight" src="../static/assets/controls/right.png" alt="right">
        </div>
        <div class="control"></div>
        <div class="control">
            <img draggable="false" class="virtual-control" id="ArrowDown" src="../static/assets/controls/down.png" alt="down">
        </div>
        <div class="control"></div>
    </div>

    <div class="main game-screen" id="main">
        <div class="col sidebar">
            <h2>Thought Graveyard</h2>
            <div id="search-section">
                <h3>Search</h3>
                <input type="text" id="search-keyword" placeholder="Keywords" class="w-full p-2 border mb-2" />
                <div>
                  <p>Emotion Filter:</p>
                  <label><input type="checkbox" class="filter-emotion" value="ðŸ˜„" /> ðŸ˜„</label>
                  <label><input type="checkbox" class="filter-emotion" value="ðŸ˜¢" /> ðŸ˜¢</label>
                  <label><input type="checkbox" class="filter-emotion" value="ðŸ˜¡" /> ðŸ˜¡</label>
                  <label><input type="checkbox" class="filter-emotion" value="ðŸ˜¶" /> ðŸ˜¶</label>
                </div>
                <ul id="search-results" class="text-sm space-y-2 mt-4"></ul>
            </div>
        </div>    
    </div>

    <!-- DOM and Flask scripts -->
    <script>
        function displayTombstone(id) {
            let tombstone;

            tombstoneData.forEach(stone => {
                if (stone.id == id) {
                    tombstone = stone;
                }
            });

            document.getElementById("tombstone-text").textContent = tombstone.content;
            document.getElementById("tombstone-likes").textContent = `${tombstone.likes} likes`;
            document.getElementById("tombstone-content").classList.remove("hidden");
        }

        function hideTombstone() {
            document.getElementById("tombstone-content").classList.add("hidden");
        }

        function showTombstoneCreator() {
            document.getElementById("tombstone-creation").classList.remove("hidden");
        }

        function hideTombstoneCreator() {
            document.getElementById("tombstone-form").reset();
            document.getElementById("tombstone-creation").classList.add("hidden");
        }

        async function loadLocalSpace() {
        try {
            // Load only local thoughts
            let request = await fetch("/api/personal-thoughts");
            
            if (!request.ok) {
                throw new Error(`HTTP error: ${request.status}`);
            }
            
            tombstoneData = await request.json();
        } catch (error) {
            // User-friendly error message
            const errorMessage = document.createElement("div");
            errorMessage.className = "error-message bg-red-100 p-2 rounded text-red-700 mb-4";
            errorMessage.textContent = "Unable to load your thoughts. Please try again later.";
            
            document.querySelector(".sidebar").appendChild(errorMessage);
            
            // Fallback to empty data
            tombstoneData = [];
            }
        }

        async function loadGlobalSpace() {
            // Load all thoughts
            let request = await fetch("/api/public-thoughts");
            
            tombstoneData = await request.json();
        }

        function loadStatsSpace() {
            tombstoneData = [];
        }

        let tombstoneData = [];
    </script>

    <!-- Canvas scripts -->
    <script defer src="../static/scripts/canvas.js"></script>
{% endblock %}